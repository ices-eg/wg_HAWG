---
output: 
  word_document:
    reference_docx: ../../_Common/report_template_v1.5.dotx
---

```{r setup, include=FALSE}
# ==============================================================================
# Natmor
#
# 06/04/2021 adapted for HAWG 2021; Irish sea herring
# ==============================================================================

require("knitr")
knitr::opts_chunk$set(
  echo = FALSE,	message = FALSE,	warning = FALSE,	comment = "",	crop = TRUE, fig.width=10) 

rm(list=ls())

#library(devtools)  ## install.packages("devtools")
library(FLCore)
library(FLSAM)
library(tidyverse)
library(RColorBrewer)

# local path (not needed in RMarkdown)

df <-
  readxl::read_xlsx(
    path="C:/TEMP/M_NSAS_raw_notExtrapolated.xlsx",
    sheet="df")


```

**Natural mortality of North Sea autumn spawning herring as generated by SMS key-runs**

**Martin Pastoors^1^**

`r format(Sys.time(), '%d/%m/%Y %H:%M')`


**M by WR (facet) and Key run (colour)**

```{r echo=FALSE, fig.align="center", fig.asp=0.8, message=FALSE, warning=FALSE}

df %>%
  ggplot(aes(x=year, y=M, group=as.character(Source))) +
  theme_bw() +
  geom_line(aes(colour=as.character(Source))) +
  facet_wrap(~WR)

```

##### page break

**M by Key run (facet) and WR (colour)**

```{r echo=FALSE, fig.align="center", fig.asp=0.5, message=FALSE, warning=FALSE}

df %>%
  ggplot(aes(x=year, y=M, group=as.character(WR))) +
  theme_bw() +
  geom_line(aes(colour=as.character(WR))) +
  facet_wrap(~Source, nrow=1)

```


##### page break

**standardized M (z-scores) by WR (facet) and Key run (colour)**

```{r echo=FALSE, fig.align="center", fig.asp=1.0, message=FALSE, warning=FALSE}

# Z scores by WR and Source

df %>%
  group_by(Source, WR) %>% 
  mutate(M_std = (M - mean(M))/sd(M) ) %>% 
  
  ggplot(aes(x=year, y=M_std, group=as.character(Source))) +
  theme_bw() +
  geom_line(aes(colour=as.character(Source))) +
  geom_hline(yintercept=0, linetype="dashed") +
  facet_wrap(~WR, nrow=3)

```

##### page break

**standardized M (z-scores) by Key run (facet) and WR (colour)**

```{r echo=FALSE, fig.align="center", fig.asp=1.3, message=FALSE, warning=FALSE}

# Z scores by Source and WR

df %>%
  group_by(Source, WR) %>% 
  mutate(M_std = (M - mean(M))/sd(M) ) %>% 
  
  ggplot(aes(x=year, y=M_std, group=as.character(WR))) +
  theme_bw() +
  geom_line(aes(colour=as.character(WR))) +
  geom_hline(yintercept=0, linetype="dashed") +
  facet_wrap(~Source, ncol=1)

```

##### page break

**M summarized by decade by WR (facet) and Key run (colour)**


```{r echo=FALSE, fig.align="center", fig.asp=0.8, message=FALSE, warning=FALSE}

# Scale by decade

df %>%
  mutate(decade = 10*floor(year/10)) %>% 
  group_by(Source, decade, WR) %>% 
  summarise(M = mean(M, na.rm=TRUE)) %>% 
  group_by(Source, WR) %>% 
  mutate(xend = lead(decade)) %>% 
  # View()
  
  ggplot(aes(x=decade, y=M, group=as.character(Source))) +
  theme_bw() +
  # geom_line(aes(colour=as.character(Source))) +
  geom_segment(aes(xend=xend, yend=M, colour=as.character(Source))) +
  expand_limits(y=0) +
  facet_wrap(~WR)

```

##### page break

**M for ages 2-6 WR only, summarized by decade (x-axis) and Key run (colour)**

```{r echo=FALSE, fig.align="center", fig.asp=0.8, message=FALSE, warning=FALSE}

# Scale by decade and 2-6 WR

df %>%
  filter(year >= 1970) %>% 
  filter(WR %in% 2:6) %>% 
  mutate(decade = 10*floor(year/10)) %>% 
  group_by(Source, decade) %>% 
  summarise(M = mean(M, na.rm=TRUE)) %>% 
  group_by(Source) %>% 
  mutate(xend = lead(decade)) %>% 
  mutate(xend = ifelse(is.na(xend), Source, xend)) %>% 
  mutate(Mend = lead(M)) %>% 
  # View()
  
  ggplot(aes(x=decade, y=M, group=as.character(Source))) +
  theme_bw() +
  # geom_line(aes(colour=as.character(Source))) +
  geom_segment(aes(xend=xend, yend=M, colour=as.character(Source))) +
  geom_segment(aes(x=xend, xend=xend, y=M, yend=Mend, colour=as.character(Source))) +
  geom_point(aes(colour=as.character(Source))) +
  expand_limits(y=0)

```

##### page break

**M standardized (z-scores) for ages 2-6 WR only, summarized by decade (x-axis) and Key run (colour)**

```{r echo=FALSE, fig.align="center", fig.asp=0.5, message=FALSE, warning=FALSE}

# Scale by decade and 2-6 WR; harmonized to the mean

df %>%
  filter(year >= 1970, year <= 2009) %>% 
  filter(WR %in% 2:6) %>% 
  mutate(decade = 10*floor(year/10)) %>% 
  group_by(Source, decade) %>% 
  summarise(M = mean(M, na.rm=TRUE)) %>% 
  group_by(Source) %>% 
  mutate(M_std = (M - mean(M))/sd(M)) %>% 
  group_by(Source) %>% 
  mutate(xend = lead(decade)) %>% 
  mutate(xend = ifelse(is.na(xend), decade+10, xend)) %>% 
  mutate(Mend = lead(M_std)) %>% 
  # View()
  
  ggplot(aes(x=decade, y=M_std, group=as.character(Source))) +
  theme_bw() +
  # geom_line(aes(colour=as.character(Source))) +
  geom_segment(aes(xend=xend, yend=M_std, colour=as.character(Source))) +
  geom_segment(aes(x=xend, xend=xend, y=M_std, yend=Mend, colour=as.character(Source))) +
  geom_hline(yintercept=0, linetype="dashed") +
  geom_point(aes(colour=as.character(Source))) 

```

```{r echo=FALSE, fig.align="center", fig.asp=0.8, message=FALSE, warning=FALSE}

# Scaling factor by decade and 2-6 WR

# df %>%
#   filter(year >= 1970) %>% 
#   filter(WR %in% 2:6) %>% 
#   mutate(decade = 10*floor(year/10)) %>% 
#   group_by(Source, decade) %>% 
#   summarise(M = mean(M, na.rm=TRUE)) %>% 
#   group_by(Source) %>% 
#   mutate(xend = lead(decade)) %>% 
#   group_by(decade) %>% 
#   mutate(Mprev = lag(M)) %>% 
#   mutate(scalor = M/Mprev-1) %>% 
#   View()
  
  # ggplot(aes(x=decade, y=scalor, group=as.character(Source))) +
  # theme_bw() +
  # # geom_line(aes(colour=as.character(Source))) +
  # geom_segment(aes(xend=xend, yend=scalor, colour=as.character(Source))) 

```
